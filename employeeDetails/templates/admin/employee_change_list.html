{% extends "admin/change_list.html" %} {% block content %} {{ block.super }}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block coltype %}colMS{% endblock %}
<div style="margin: 10px; padding: 10px; border: 1px solid #fff">
  <h3>Total Salary Summary: <span class="total-salary">0</span></h3>

  <!-- Popup Modal -->
<div id="taskMenu" style="display:none; position:absolute; top:0; left:0; 
                width:100%; height:100%; background:rgba(0,0,0,0.5); 
                justify-content:center; align-items:center; z-index: 999;">

</div>
  



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
      let totalSalary = 0;
      const baseURL = "http://127.0.0.1:8000/api/";

      $(".field-salary").each(function () {
        let raw = $(this).text();
        let salary = parseFloat(raw) || 0;
        totalSalary += salary;
        let empId = $(this).closest("tr").data("object-id");

        $(this).html(`
          <input type="number" 
                 class="salary-input" 
                 data-id="${empId}" 
                 value="${salary}" 
                 style="width:100px;" />
        `);
      });

      function tableDetails() {
        salarySum = 0;

        $.ajax({
          url: `${baseURL}emp/list/`,
          type: "GET",
          success: function (response) {
            response.forEach((emp) => {
              salarySum += parseFloat(emp.salary);
            });

            $(".total-salary").text(salarySum.toFixed(2));
          },
        });
      }

      tableDetails();
        $(".salary-input").on("change", function () {
          let total = 0;
          $(".salary-input").each(function () {
            let val = parseFloat($(this).val()) || 0;
            total += val;
             const csrftoken = document.querySelector(
              "[name=csrfmiddlewaretoken]"
            ).value;
          let id = $(this).closest("tr").data("object-id") || $(this).closest("tr").find(".field-id").text().trim();
            console.log(id)
            $.ajax({
              url: `${baseURL}emp/${id}/`,
              type: "PATCH",
              data: JSON.stringify({ salary: val }),
              contentType: "application/json",
              headers: { "X-CSRFToken": csrftoken },
              success: function (response) {
                console.log("Salary updated successfully:", response);
              },
            });
            $(".total-salary").text(total.toFixed(2));
          });

          $(".total-salary").text(total.toFixed(2));
        });
       
    });
 
const baseUrl = "http://127.0.0.1:8000/api/";
const menu = document.getElementById("taskMenu");
function closeModal() {
  $("#taskMenu").hide().empty();
}

function updateTask(event,id) {
  event.preventDefault();
  let task = document.getElementById("taskInput").value;
  let status = document.getElementById("taskStatus").value;
  let deadline = document.getElementById("taskDeadline").value;
  const csrftoken = document.querySelector(
    "[name=csrfmiddlewaretoken]"
  ).value;

  $.ajax({
    url: `${baseUrl}update/task/${id}/`,
    type: "PATCH",
    data: JSON.stringify({ task:task, status: status, deadline: deadline }),
    contentType: "application/json",
    headers: { "X-CSRFToken": csrftoken },
    success: function (response) {
      console.log("Task updated successfully:", response);
      closeModal();
      location.reload();
    },
    error: function (error) {
      console.error("Error updating task:", error);
    },
  });
}

async function getTaskDetails(event, id) {
  event.preventDefault();
  const menu = document.getElementById("taskMenu");
  console.log(id,"----")
  try {
    const response = await fetch(`/api/update/task/${id}/`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
      }
    });

    if (!response.ok) {
      throw new Error("Network response was not ok");
    }

    const data = await response.json();

    let currentStatus = data.status;
    menu.style.display = "block";

    let selectHTML = `
      <div style="background:#fff; padding:20px; border-radius:10px; width:400px; margin: 0 auto; top:100px; position: relative">
        <h3>Edit Task</h3>
        <form id="taskForm" onsubmit="updateTask(event,${data.id})">
          <input type="hidden" id="taskId" value="${data.id}" data-id="${data.id}">
          
          <div>
            <label>Task:</label>
            <input type="text" id="taskInput" value="${data.task}">
          </div>
          <div>
            <label>Status:</label>
            <select id="taskStatus">
              <option value="pending" ${currentStatus === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="in_progress" ${currentStatus === 'in_progress' ? 'selected' : ''}>In Progress</option>
            </select>
          </div>
          <div>
            <label>Deadline:</label>
            <input type="date" id="taskDeadline" value="${data.deadline}">
          </div>
          <button type="submit">Save</button>
          <button type="button" onclick="closeModal()">Cancel</button>
        </form>
      </div>`;
    
    menu.innerHTML = selectHTML;
  } catch (error) {
    menu.style.display = "block";
    menu.innerHTML = `
      <h1 style="color:red; font-weight:900;">No Task Assigned</h1>
      <button type="button" onclick="closeModal()">Close</button>
    `;
    console.error("Error fetching task details:", error);
  }
}



</script> 
</div>
{% endblock %}
