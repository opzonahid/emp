{% block employees %}
<div>
  <h1>Employees List</h1>
  <table>
    <tr>
      <th>Emp ID</th>
      <th>Employees Name</th>
      <th>Department</th>
      <th>Role</th>
      <th>Salary</th>
    </tr>
    <tbody id="employeesId"></tbody>
  </table>
</div>
{% endblock employees %} {% comment %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endcomment %} {% comment %}
<script>
  const empTableBody = document.querySelector("#employeesId");
  const baseURL = "http://127.0.0.1:8000/api/";

  async function fetchData() {
    try {
      const response = await axios.get(`${baseURL}emp/list/`);
      const employees = response.data;

      // Clear table before adding new rows
      empTableBody.innerHTML = "";

      let salarySum = 0;

      employees.forEach((emp) => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        const td3 = document.createElement("td");
        const td4 = document.createElement("td");
        const td5 = document.createElement("td");

        td1.textContent = emp.id;
        td2.textContent = emp.user;
        td3.textContent = emp.department;
        td4.textContent = emp.role;
        td5.textContent = emp.salary;

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tr.appendChild(td5);

        empTableBody.appendChild(tr);

        salarySum += parseFloat(emp.salary);
      });

      const totalRow = document.createElement("tr");

      const tdLabel = document.createElement("td");
      tdLabel.colSpan = 4;
      tdLabel.style.fontWeight = "bold";
      tdLabel.textContent = "Total Salary";

      const tdTotal = document.createElement("td");
      tdTotal.style.fontWeight = "bold";
      tdTotal.textContent = salarySum.toFixed(2);

      totalRow.appendChild(tdLabel);
      totalRow.appendChild(tdTotal);

      empTableBody.appendChild(totalRow);
    } catch (error) {
      console.error("Error fetching employees:", error);
    }
  }

  fetchData();
</script>
{% endcomment %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% comment %}
<script>
  $(document).ready(function () {
    let salarySum = 0;
    const empTableBody = document.querySelector("#employeesId");
    const baseURL = "http://127.0.0.1:8000/api/";

    function tableDetails() {
      $.ajax({
        url: `${baseURL}emp/list/`,
        type: "GET",
        success: function (response) {
          response.forEach((emp) => {
            const rows = `<tr>
                                    <td>${emp.id}</td>
                                    <td>${emp.user}</td>
                                    <td>${emp.department}</td>
                                    <td>${emp.role}</td>
                                    <td onclick=salaryUpdate(${emp.id}) class="salary${emp.id}"><span>${emp.salary}</span></td>
                                </tr>`;
            empTableBody.innerHTML += rows;
            salarySum += parseFloat(emp.salary);
            console.log(emp);
          });
          const totalRow = `<tr>
                                    <td>Total Salary:</td>
                                    <td>${salarySum}</td>
                                </tr>`;

          empTableBody.innerHTML += totalRow;
        },
      });
    }

    empTableBody.addEventListener("click", function (event) {
      if (event.target.closest(".salary")) {
        const td = event.target.closest(".salary");
        const id = td.dataset.id;
        salaryUpdate(id, td);
      }
    });

    function salaryUpdate(id) {
      const td = document.querySelector(`.salary${id}`);
      if (!td) return;
      const span = td.querySelector("span");
      if (!span) return;

      const input = document.createElement("input");
      input.type = "number";
      input.value = span.textContent;
      input.style.width = "80px";

      span.replaceWith(input);
      input.focus();
      span.addEventListener("click", function () {
        const newSalary = input.value;

        $.ajax({
          url: `${baseURL}emp/${id}/`,
          type: "PATCH",
          data: JSON.stringify({ salary: newSalary }),
          contentType: "application/json",

          success: function (response) {
            tableDetails();
            console.log("Salary updated successfully", response);
            input.replaceWith(span);
            span.textContent = newSalary;
          },
        });
      });
    }

    tableDetails();

    // Delegate click event to salary cells
  });
</script>
{% endcomment %} {% comment %}
<script>
  $(document).ready(function () {
    let salarySum = 0;
    let newSalary = 0;
    const empTableBody = document.querySelector("#employeesId");
    const baseURL = "http://127.0.0.1:8000/api/";

    function tableDetails() {
      empTableBody.innerHTML = "";
      salarySum = 0;

      $.ajax({
        url: `${baseURL}emp/list/`,
        type: "GET",
        success: function (response) {
          response.forEach((emp) => {
            const rows = `<tr>
                                    <td>${emp.id}</td>
                                    <td>${emp.user}</td>
                                    <td>${emp.department}</td>
                                    <td>${emp.role}</td>
                                    <td class="salary" id="salary-id" data-id="${emp.id}">
                                        <span value="${emp.salary}">${emp.salary}</span>
                                    </td>
                                  </tr>`;
            empTableBody.innerHTML += rows;
            salarySum += parseFloat(emp.salary);
          });

          const totalRow = `<tr>
                                    <td>Total Salary:</td>
                                    <td id="totalSalary">${salarySum}</td>
                                  </tr>`;
          empTableBody.innerHTML += totalRow;
        },
      });
    }

    empTableBody.addEventListener("click", function (event) {
      if (event.target.closest(".salary")) {
        const td = event.target.closest(".salary");
        const id = td.dataset.id;
        salaryUpdate(id, td);
      }
    });

    function salaryUpdate(id, td) {
      const span = td.querySelector("span");
      if (!span) return;

      const input = document.createElement("input");
      input.type = "number";
      input.value = span.textContent;
      input.style.width = "80px";
      input.classList.add("salaryInput");

      span.replaceWith(input);
      input.focus();
      const csrftoken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      input.addEventListener("blur", function () {
        const newSalary = input.value;

        $.ajax({
          url: `${baseURL}emp/${id}/`,
          type: "PATCH",
          data: JSON.stringify({ salary: newSalary }),
          contentType: "application/json",
          headers: { "X-CSRFToken": csrftoken },

          success: function (response) {
            input.replaceWith(span);
            span.textContent = newSalary;

            $(".salary").on("input", function () {
              salarySum += newSalary;
              $("#totalSalary").text(salarySum);
            });
            tableDetails();
          },
          error: function (error) {
            console.error("Error updating salary:", error);
            input.replaceWith(span);
          },
        });
      });
    }

    function recalcTotal() {
      let total = 0;
      console.log(total);

      $("#employeesId .salaryInput").each(function () {
        const value = parseFloat($(this).val()) || 0;
        console.log(this);
        total += value;
      });
      $("#totalSalary").text(total + salarySum);
    }

    $(document).on("change", ".salaryInput", function () {
      setTimeout(recalcTotal, 100);
    });

    tableDetails();
  });
</script>
{% endcomment %}

<script>
  $(document).ready(function () {
    let salarySum = 0;
    let newSalary = 0;
    const empTableBody = document.querySelector("#employeesId");
    const baseURL = "http://127.0.0.1:8000/api/";

    function tableDetails() {
      empTableBody.innerHTML = "";
      salarySum = 0;

      $.ajax({
        url: `${baseURL}emp/list/`,
        type: "GET",
        success: function (response) {
          response.forEach((emp) => {
            const rows = `<tr>
                                    <td>${emp.id}</td>
                                    <td>${emp.user}</td>
                                    <td>${emp.department}</td>
                                    <td>${emp.role}</td>
                                    {% comment %} <td class="salary" id="salary-id" data-id="${emp.id}">
                                        <span class="amount-input" value="${emp.salary}">${emp.salary}</span>
                                    </td> {% endcomment %}
                                    <td>
                            <input id="${emp.id}"
                                   type="number"
                                   class="amount-input form-control"
                                   step="1"
                                   min="0"
                                   value="${emp.salary}" />
                        </td>
                                  </tr>`;
            empTableBody.innerHTML += rows;
            salarySum += parseFloat(emp.salary);
          });

          const totalRow = `<tr>
                                    <td>Total Salary:</td>
                                    <td id="totalSalary">${salarySum}</td>
                                  </tr>`;
          empTableBody.innerHTML += totalRow;
        },
      });
    }

    empTableBody.addEventListener("click", function (event) {
      if (event.target.closest(".salary")) {
        const td = event.target.closest(".salary");
        const id = td.dataset.id;
        salaryUpdate(id, td);
      }
    });

    function recalcTotal() {
      let total = 0;

      $(".amount-input").each(function () {
        let val = parseFloat($(this).val()) || 0;
        total += val;
      });

      $("#totalSalary").text(total);
    }

    $(document).on("keyup change", ".amount-input", function () {
      recalcTotal();
    });

    $(document).on("blur", ".amount-input", function () {
      const input = $(this);
      const newSalary = input.val();
      const id = input.attr("id");
      const csrftoken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      $.ajax({
        url: `${baseURL}emp/${id}/`,
        type: "PATCH",
        data: JSON.stringify({ salary: newSalary }),
        contentType: "application/json",
        headers: { "X-CSRFToken": csrftoken },

        success: function (response) {
          console.log("Updated successfully", response);
          recalcTotal();
        },
        error: function (error) {
          console.error("Error updating salary:", error);
        },
      });
    });

    recalcTotal();

    tableDetails();
   
  });

</script>
